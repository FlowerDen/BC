<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BigCommerce Modifier Manager</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      padding: 40px;
    }

    h1 { color: #667eea; margin-bottom: 10px; font-size: 32px; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 16px; }

    .section { margin-bottom: 30px; }
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 20px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 8px;
      font-weight: 600;
    }

    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
    input[type="text"], input[type="number"], input[type="password"], select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.12);
    }

    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    button:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 123, 255, 0.25);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover {
      background: #5a6268;
      box-shadow: 0 6px 18px rgba(108, 117, 125, 0.25);
    }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover {
      background: #b52a37;
      box-shadow: 0 6px 18px rgba(220, 53, 69, 0.25);
    }

    .modifier-config {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #e0e6ed;
    }
    .modifier-item {
  display: grid;
  grid-template-columns: 2.6fr 1.4fr 1.2fr 1.2fr auto;
  gap: 10px;
  margin-bottom: 15px;
  align-items: end;
}
    .field-label {
      font-size: 12px;
      font-weight: 700;
      color: #444;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .tab-buttons { display: flex; gap: 0; margin-bottom: 20px; }
    .tab-button {
      flex: 1;
      padding: 12px 24px;
      background: #e9ecef;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      color: #667eea;
      font-weight: 700;
      border-radius: 0;
      box-shadow: none;
      transform: none;
    }
    .tab-button:hover { background: #dee2e6; }
    .tab-button.active { background: #fff; border-bottom-color: #007bff; color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .selected-box {
      margin-top: 12px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
    }
    .selected-box h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-weight: 800;
      font-size: 12px;
      margin-left: 6px;
    }

    .selected-tools {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .selected-tools button {
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 700;
    }
    .small {
      font-size: 12px;
      color: #666;
    }

    .product-list {
      display: grid;
      gap: 8px;
      max-height: 260px;
      overflow: auto;
      padding-right: 6px;
    }
    .product-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
    }
    .product-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .product-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1;
    }
    .product-name {
      font-weight: 800;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-id {
      font-size: 12px;
      color: #6b7280;
      font-weight: 700;
    }

    .options-card {
      margin-top: 12px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
    }
    .options-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
    }
    .options-row label {
      margin: 0;
      font-weight: 700;
      color: #333;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
    }
    .options-row input[type="radio"] { transform: translateY(1px); }
    .options-inline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .results { margin-top: 30px; }
    .result-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #28a745;
    }
    .result-item.error { border-left-color: #dc3545; }
    .result-header { font-weight: 800; margin-bottom: 8px; color: #333; }
    .result-details { font-size: 13px; color: #666; }
    .result-details div { margin: 3px 0; }
    .loading { text-align: center; padding: 20px; color: #666; }

    code {
      background: #111827;
      color: #fff;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üõ†Ô∏è BigCommerce Modifier Manager</h1>
    <p class="subtitle">Manage product modifiers across multiple products with ease</p>

    <!-- Settings Banner -->
    <div id="settingsBanner"
      style="background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:8px;margin-bottom:20px;display:none;">
      <strong>‚öôÔ∏è API Settings:</strong>
      <span id="settingsStatus">Not configured</span>
      <button onclick="openSettings()"
        style="margin-left:10px;padding:6px 12px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:800;">
        Configure
      </button>
    </div>

    <!-- Settings Modal (fallback) -->
    <div id="settingsModal"
      style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:white;padding:30px;border-radius:12px;max-width:520px;width:92%;">
        <h2 style="margin-top:0;">API Configuration</h2>
        <p style="color:#666;margin-bottom:20px;">
          If OAuth didn‚Äôt populate your session, you can enter a Store Hash + Token as a fallback.
        </p>

        <div class="input-group">
          <label>Store Hash:</label>
          <input type="text" id="settingsStoreHash" placeholder="e.g., jxetu2nhyu" />
        </div>

        <div class="input-group">
          <label>API Access Token:</label>
          <input type="password" id="settingsAccessToken" placeholder="Your API token" />
        </div>

        <div style="margin-top:20px;display:flex;gap:10px;">
          <button onclick="saveSettings()" style="flex:1;">Save Settings</button>
          <button onclick="closeSettings()" class="btn-secondary" style="flex:1;">Cancel</button>
        </div>

        <div id="settingsError" style="color:#dc3545;margin-top:15px;display:none;font-weight:700;"></div>
        <div id="settingsSuccess" style="color:#28a745;margin-top:15px;display:none;font-weight:700;"></div>
      </div>
    </div>

    <div class="section">
      <h2>1. Select Products</h2>

      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('single')">Single Product</button>
        <button class="tab-button" onclick="switchTab('category')">By Category</button>
        <button class="tab-button" onclick="switchTab('multiple')">Multiple Products</button>
      </div>

      <div id="tab-single" class="tab-content active">
        <div class="input-group">
          <label>Product ID:</label>
          <input type="number" id="productId" placeholder="e.g., 350" />
        </div>

        <div class="input-group">
          <label>Search Product by Name:</label>
          <input type="text" id="productNameSearch" placeholder="Start typing a product name‚Ä¶" autocomplete="off" />
          <div id="productNameResults" class="product-list" style="margin-top:8px; display:none;"></div>
          <div class="small" style="margin-top:6px;">
            Click a result to auto-fill Product ID and preview.
          </div>
        </div>

        <button class="btn-secondary" onclick="refreshSelectedProducts()">Preview Selected</button>

        <div class="small" style="margin-top:10px;">
          Tip: after preview loads, you can uncheck items in the list below (useful if you switch tabs).
        </div>
      </div>

      <div id="tab-category" class="tab-content">
        <div class="input-group">
          <label>Category ID:</label>
          <input type="number" id="categoryId" placeholder="e.g., 52" />
        </div>

        <div class="input-group">
          <label>Search Category by Name:</label>
          <input type="text" id="categoryNameSearch" placeholder="Start typing a category name‚Ä¶" autocomplete="off" />
          <div id="categoryNameResults" class="product-list" style="margin-top:8px; display:none;"></div>
          <div class="small" style="margin-top:6px;">
            Click a result to auto-fill Category ID.
          </div>
        </div>

        <button class="btn-secondary" onclick="loadCategoryProducts()">Load Products from Category</button>
      </div>

      <div id="tab-multiple" class="tab-content">
        <div class="input-group">
          <label>Product IDs (comma-separated):</label>
          <input type="text" id="multipleProductIds" placeholder="e.g., 350, 423, 196" />
        </div>
        <button class="btn-secondary" onclick="refreshSelectedProducts()">Preview Selected</button>
        <div class="small" style="margin-top:10px;">
          Example: <code>350,423,196</code>
        </div>
      </div>

      <div class="selected-box">
        <h3>
          <span>Selected Products <span class="pill" id="selectedCount">0</span></span>
          <span class="small" id="selectedHint"></span>
        </h3>

        <div class="selected-tools">
          <button class="btn-secondary" onclick="selectAllVisible(true)">Select all</button>
          <button class="btn-secondary" onclick="selectAllVisible(false)">Select none</button>
          <button class="btn-secondary" onclick="refreshSelectedProducts()">Refresh</button>
          <div class="small">Only checked items will be affected.</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0;">
          <input
            type="text"
            id="productSearch"
            placeholder="Search‚Ä¶"
            oninput="applyProductFilter()"
            style="flex:1; min-width:220px;"
          />

          <div class="options-row" style="margin:0;">
            <label style="margin:0;">
              <input type="radio" name="productSearchMode" value="name" checked onchange="applyProductFilter()">
              Name
            </label>
            <label style="margin:0;">
              <input type="radio" name="productSearchMode" value="id" onchange="applyProductFilter()">
              ID
            </label>
          </div>

          <button class="btn-secondary" onclick="clearProductFilter()">Clear</button>
        </div>

        <div id="selectedProductsList" class="product-list">
          <div style="color:#777;">Nothing selected yet.</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Templates</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
        <select id="templateSelect" style="min-width:260px;"></select>
        <button class="btn-secondary" onclick="refreshTemplates()">Refresh</button>
        <button class="btn-secondary" onclick="loadSelectedTemplate()">Load</button>
        <button class="btn-danger" onclick="deleteTemplate()">Delete</button>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <input id="templateNameInput" placeholder="Template name" style="min-width:260px;" />
        <button onclick="saveNewTemplate()">Save as Template</button>
        <button class="btn-secondary" onclick="updateTemplate()">Update Selected</button>
      </div>

      <div class="small" style="margin-top:6px;">
        Tip: Build your modifiers below, then use <b>Save as Template</b>.
      </div>

      <div id="templateStatus" class="small" style="margin-top:8px;"></div>
    </div>

    <div class="section">
      <h2>2. Configure Modifiers</h2>

      <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
        <button class="btn-secondary" onclick="loadPreset('standard')" style="flex:1;min-width:220px;">Load Standard Set</button>
        <button class="btn-secondary" onclick="loadPreset('custom')" style="flex:1;min-width:220px;">Load Custom</button>
        <button class="btn-secondary" onclick="clearConfig()" style="flex:1;min-width:220px;">Clear All</button>
        <button onclick="quickSaveTemplateFromModifiers()" style="flex:1;min-width:220px;">Save as Template</button>
      </div>

      <div style="display:grid;grid-template-columns:2.6fr 1.4fr 1.2fr 1.2fr auto;gap:10px;margin-bottom:10px;padding:0 5px;">
        <div class="field-label">Modifier Display Name</div>
        <div class="field-label">Type</div>
        <div class="field-label">
          Sort Order<br>
          <span style="font-size:10px;text-transform:none;font-weight:normal;">
            (Lower = appears first)
          </span>
        </div>
        <div class="field-label">
          Price Adjuster<br>
          <span style="font-size:10px;text-transform:none;font-weight:normal;">
            (Checkbox only)
          </span>
        </div>
        <div></div>
      </div>

      <div class="modifier-config">
        <div id="modifierList"></div>
        <button class="btn-secondary" onclick="addModifier()">+ Add Modifier</button>
      </div>
    </div>

    <div class="section">
      <h2>3. Options</h2>

      <div class="options-card">
        <div class="small">
          Choose what happens to existing modifiers before applying your modifier set.
        </div>

        <div class="options-row">
          <label><input type="radio" name="deleteMode" value="none"> Don‚Äôt delete anything</label>
          <label><input type="radio" name="deleteMode" value="match" checked> Delete only matching names</label>
          <label><input type="radio" name="deleteMode" value="all"> Delete ALL modifiers</label>
        </div>

        <div class="options-inline" id="matchNamesRow">
          <div style="flex:1; min-width:280px;">
            <label for="deleteNameIncludes" style="margin-bottom:6px;">Names to delete (comma-separated)</label>
            <input type="text" id="deleteNameIncludes" value="Custom Ribbon, Full Size Card" />
            <div class="small" style="margin-top:6px;">
              Example: <code>Custom Ribbon, Full Size Card</code>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" style="display:flex;gap:10px;flex-wrap:wrap;">
      <button onclick="applyModifiers()" id="applyBtn">Apply Modifier Set</button>
      <button class="btn-danger" onclick="removeAllModifiers()" id="removeBtn">Remove ALL Modifiers</button>
      <button class="btn-secondary" onclick="refreshSelectedProducts()">Refresh Selected List</button>
    </div>

    <div id="results" class="results"></div>
  </div>

  <script>
  let modifierCount = 0;

  // Holds: [{id, name, selected}]
  let selectedProducts = [];
  let filteredSelectedProducts = [];

  window.addEventListener('DOMContentLoaded', async () => {
    await checkSettings();
    loadPreset('standard');
    wireOptionToggles();

    // wire up name typeaheads
    wireProductNameTypeahead();
    wireCategoryNameTypeahead();

    refreshSelectedProducts(); // harmless if empty
    await refreshTemplates();
  });

  /* ===============================
     Settings
  ================================ */
  async function checkSettings() {
    try {
      const response = await fetch('/api/settings');
      const settings = await response.json();

      const banner = document.getElementById('settingsBanner');
      const status = document.getElementById('settingsStatus');

      if (settings.storeHash && settings.hasToken) {
        const mode = settings.isOAuth ? 'OAuth session' : 'Manual token';
        status.textContent = `Store: ${settings.storeHash} | Token: ${settings.tokenPreview} | ${mode}`;
        banner.style.background = '#d4edda';
        banner.style.borderColor = '#28a745';
      } else {
        status.textContent = 'OAuth session not detected. Click "Configure" only if needed.';
        banner.style.background = '#fff3cd';
        banner.style.borderColor = '#ffc107';
      }

      banner.style.display = 'block';
    } catch (error) {
      console.error('Failed to check settings:', error);
    }
  }

  function openSettings() {
    document.getElementById('settingsModal').style.display = 'flex';
  }

  function closeSettings() {
    document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('settingsError').style.display = 'none';
    document.getElementById('settingsSuccess').style.display = 'none';
  }

  async function saveSettings() {
    const storeHash = document.getElementById('settingsStoreHash').value.trim();
    const accessToken = document.getElementById('settingsAccessToken').value.trim();
    const errorDiv = document.getElementById('settingsError');
    const successDiv = document.getElementById('settingsSuccess');

    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    if (!storeHash || !accessToken) {
      errorDiv.textContent = 'Please enter both store hash and access token';
      errorDiv.style.display = 'block';
      return;
    }

    try {
      const response = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ storeHash, accessToken })
      });

      const result = await response.json();

      if (response.ok) {
        successDiv.textContent = 'Settings saved successfully!';
        successDiv.style.display = 'block';

        setTimeout(() => {
          closeSettings();
          checkSettings();
          refreshSelectedProducts();
        }, 900);
      } else {
        throw new Error(result.error || 'Failed to save settings');
      }
    } catch (error) {
      errorDiv.textContent = error.message;
      errorDiv.style.display = 'block';
    }
  }

  /* ===============================
     Tabs
  ================================ */
  function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');

    // Clear visual list (avoids confusion) but keep state until refreshed
    document.getElementById('selectedHint').textContent = '';
    refreshSelectedProducts();
  }

  /* ===============================
     Selection helpers
  ================================ */
  function parseMultipleIds() {
    const ids = document.getElementById('multipleProductIds').value || '';
    return ids
      .split(',')
      .map(x => parseInt(x.trim(), 10))
      .filter(n => Number.isFinite(n));
  }

  function getActiveTabId() {
    return document.querySelector('.tab-content.active')?.id;
  }

  function getInputIdsFromTab() {
    const active = getActiveTabId();

    if (active === 'tab-single') {
      const v = parseInt(document.getElementById('productId').value, 10);
      return Number.isFinite(v) ? [v] : [];
    }

    if (active === 'tab-category') {
      // category selection comes from selectedProducts after load
      return selectedProducts.map(p => p.id);
    }

    if (active === 'tab-multiple') {
      return parseMultipleIds();
    }

    return [];
  }

  // IDs that will actually be affected (checked)
  function getCheckedIds() {
    return selectedProducts.filter(p => !!p.selected).map(p => p.id);
  }

  function escapeHtml(s) {
    return String(s || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ---------- Typeahead helpers ----------
  async function safeJson(res) {
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return { error: text || `Non-JSON response (HTTP ${res.status})` }; }
  }

  function debounce(fn, delay = 250) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  function getTypeSelectHtml(id, selectedType) {
    const t = selectedType || 'checkbox';
    return `
      <select id="type-${id}" onchange="onTypeChange(${id})">
        <option value="checkbox" ${t === 'checkbox' ? 'selected' : ''}>Checkbox</option>
        <option value="text" ${t === 'text' ? 'selected' : ''}>Text</option>
        <option value="multi_line_text" ${t === 'multi_line_text' ? 'selected' : ''}>Multi-line text</option>
        <option value="date" ${t === 'date' ? 'selected' : ''}>Date</option>
      </select>
    `;
  }

  function getSearchMode() {
    return document.querySelector('input[name="productSearchMode"]:checked')?.value || 'name';
  }

  function applyProductFilter() {
    const q = (document.getElementById('productSearch')?.value || '').trim().toLowerCase();
    const mode = getSearchMode();

    if (!q) {
      filteredSelectedProducts = [...selectedProducts];
      renderSelectedProducts(filteredSelectedProducts);
      return;
    }

    filteredSelectedProducts = selectedProducts.filter(p => {
      if (mode === 'id') return String(p.id).includes(q);
      return String(p.name || '').toLowerCase().includes(q);
    });

    renderSelectedProducts(filteredSelectedProducts);
  }

  function clearProductFilter() {
    const input = document.getElementById('productSearch');
    if (input) input.value = '';
    filteredSelectedProducts = [...selectedProducts];
    renderSelectedProducts(filteredSelectedProducts);
  }

  function onTypeChange(id) {
    const type = document.getElementById(`type-${id}`)?.value || 'checkbox';
    const priceEl = document.getElementById(`price-${id}`);

    if (!priceEl) return;

    if (type !== 'checkbox') {
      priceEl.value = '';
      priceEl.disabled = true;
      priceEl.placeholder = 'N/A';
    } else {
      priceEl.disabled = false;
      priceEl.placeholder = 'Price (+$)';
    }
  }

  function setSelectedHint(text) {
    document.getElementById('selectedHint').textContent = text || '';
  }

  function renderSelectedProducts(items) {
    const listEl = document.getElementById('selectedProductsList');
    const countEl = document.getElementById('selectedCount');

    const checkedCount = selectedProducts.filter(p => p.selected).length;
    countEl.textContent = String(checkedCount);

    if (!items.length) {
      listEl.innerHTML = `<div style="color:#777;">Nothing selected yet.</div>`;
      return;
    }

    listEl.innerHTML = items.map(p => `
      <div class="product-row">
        <input type="checkbox" ${p.selected ? 'checked' : ''} onchange="toggleProduct(${p.id}, this.checked)" />
        <div class="product-meta">
          <div class="product-name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</div>
          <div class="product-id">ID: ${p.id}</div>
        </div>
      </div>
    `).join('');
  }

  function toggleProduct(productId, isSelected) {
    const idx = selectedProducts.findIndex(p => p.id === productId);
    if (idx >= 0) {
      selectedProducts[idx].selected = !!isSelected;
      document.getElementById('selectedCount').textContent =
        String(selectedProducts.filter(p => p.selected).length);
      applyProductFilter();
    }
  }

  function selectAllVisible(checked) {
    const q = (document.getElementById('productSearch')?.value || '').trim();

    // If there is NO search query, affect ALL selectedProducts
    if (!q) {
      selectedProducts = selectedProducts.map(p => ({ ...p, selected: !!checked }));
      filteredSelectedProducts = [...selectedProducts];
      applyProductFilter();
      return;
    }

    // If a search query exists, affect ONLY the visible (filtered) rows
    const visibleIds = new Set((filteredSelectedProducts || []).map(p => p.id));
    selectedProducts = selectedProducts.map(p =>
      visibleIds.has(p.id) ? { ...p, selected: !!checked } : p
    );

    applyProductFilter();
  }

  // Preview/refresh selection list for single & multiple (and category if already loaded)
  async function refreshSelectedProducts() {
    const active = getActiveTabId();
    const ids = getInputIdsFromTab();

    // If category tab: we only show what was loaded (don‚Äôt auto-load)
    if (active === 'tab-category') {
      if (!selectedProducts.length) {
        setSelectedHint('Load a category to populate products.');
        document.getElementById('selectedCount').textContent = '0';
        document.getElementById('selectedProductsList').innerHTML = `<div style="color:#777;">Nothing selected yet.</div>`;
        return;
      }

      setSelectedHint('Category loaded. Uncheck any items you want to exclude.');

      // Ensure selected defaults to true if missing
      selectedProducts = selectedProducts.map(p => ({ ...p, selected: (p.selected !== false) }));

      // Keep filtered list in sync and render via filter
      filteredSelectedProducts = [...selectedProducts];
      applyProductFilter(); // renders filteredSelectedProducts
      return;
    }

    // Single/multiple: build list from ids, fetch names per id (does not rely on /lookup)
    if (!ids.length) {
      selectedProducts = [];
      filteredSelectedProducts = [];
      setSelectedHint('');
      document.getElementById('selectedCount').textContent = '0';
      document.getElementById('selectedProductsList').innerHTML = `<div style="color:#777;">Nothing selected yet.</div>`;
      return;
    }

    setSelectedHint('Preview loaded. Uncheck any items you want to exclude.');

    // Loading state
    document.getElementById('selectedProductsList').innerHTML = `<div style="color:#777;">Loading product names‚Ä¶</div>`;

    const items = [];
    for (const id of ids) {
      try {
        const r = await fetch(`/api/products/${id}`);
        const data = await safeJson(r);
        if (!r.ok) throw new Error(data?.error || `Failed to load product ${id}`);
        items.push({ id: Number(data.id || id), name: data.name || '(unknown)', selected: true });
      } catch (e) {
        items.push({ id, name: `(lookup failed)`, selected: true });
      }
    }

    selectedProducts = items;
    filteredSelectedProducts = [...selectedProducts];
    applyProductFilter();
  }

  // Load category products (server returns id+name)
  async function loadCategoryProducts() {
    const categoryId = document.getElementById('categoryId').value;
    if (!categoryId) return alert('Enter a category ID');

    setSelectedHint('Loading category products‚Ä¶');
    document.getElementById('selectedProductsList').innerHTML =
      `<div style="color:#777;">Loading products‚Ä¶</div>`;
    document.getElementById('selectedCount').textContent = '0';

    try {
      const res = await fetch(`/api/products/category/${categoryId}`);
      const products = await safeJson(res);

      if (!res.ok) {
        throw new Error(products?.error || 'Failed to load category products');
      }

      if (!Array.isArray(products) || !products.length) {
        selectedProducts = [];
        filteredSelectedProducts = [];
        setSelectedHint('No products found in that category.');
        applyProductFilter();
        return;
      }

      selectedProducts = products.map(p => ({
        id: Number(p.id),
        name: p.name || '(unknown)',
        selected: true
      }));

      filteredSelectedProducts = [...selectedProducts];

      setSelectedHint('Category loaded. Uncheck any items you want to exclude.');
      applyProductFilter();
    } catch (e) {
      console.error(e);
      alert(`Error loading category: ${e.message}`);
      setSelectedHint('');
      selectedProducts = [];
      filteredSelectedProducts = [];
      applyProductFilter();
    }
  }

  /* ===============================
     Typeahead: Product + Category name search
  ================================ */

  // Renders dropdown rows and lets click choose an item
  function renderTypeaheadResults(containerEl, rows, onPick) {
    if (!containerEl) return;

    if (!Array.isArray(rows) || rows.length === 0) {
      containerEl.style.display = 'none';
      containerEl.innerHTML = '';
      return;
    }

    containerEl.style.display = 'grid';
    containerEl.innerHTML = rows.map(r => `
      <div class="product-row" data-id="${escapeHtml(String(r.id))}" style="cursor:pointer;">
        <div class="product-meta">
          <div class="product-name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
          <div class="product-id">ID: ${escapeHtml(String(r.id))}</div>
        </div>
      </div>
    `).join('');

    // click handler (event delegation)
    containerEl.onclick = (e) => {
      const row = e.target.closest('.product-row');
      if (!row) return;
      const id = row.getAttribute('data-id');
      const picked = rows.find(x => String(x.id) === String(id));
      if (picked) onPick(picked);
    };
  }

  // --- Product name search ---
  async function searchProductsByName(q) {
    const res = await fetch(`/api/products/search?name=${encodeURIComponent(q)}`);
    const data = await safeJson(res);
    if (!res.ok) throw new Error(data?.error || `Product search failed (HTTP ${res.status})`);
    return Array.isArray(data) ? data : [];
  }

  function wireProductNameTypeahead() {
    const input = document.getElementById('productNameSearch');
    const results = document.getElementById('productNameResults');
    const idInput = document.getElementById('productId');

    if (!input || !results || !idInput) return;

    const run = debounce(async () => {
      const q = (input.value || '').trim();
      if (q.length < 2) {
        results.style.display = 'none';
        results.innerHTML = '';
        return;
      }

      try {
        const rows = await searchProductsByName(q);
        renderTypeaheadResults(results, rows.slice(0, 25), (picked) => {
          idInput.value = picked.id;
          input.value = picked.name;
          results.style.display = 'none';
          results.innerHTML = '';
          // auto-preview
          refreshSelectedProducts();
        });
      } catch (e) {
        results.style.display = 'grid';
        results.innerHTML = `<div style="color:#dc3545;font-weight:700;">${escapeHtml(e.message)}</div>`;
      }
    }, 250);

    input.addEventListener('input', run);

    // close results when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target === input || results.contains(e.target)) return;
      results.style.display = 'none';
    });
  }

  // --- Category name search ---
  async function searchCategoriesByName(q) {
    const res = await fetch(`/api/categories/search?name=${encodeURIComponent(q)}`);
    const data = await safeJson(res);
    if (!res.ok) throw new Error(data?.error || `Category search failed (HTTP ${res.status})`);
    return Array.isArray(data) ? data : [];
  }

  function wireCategoryNameTypeahead() {
    const input = document.getElementById('categoryNameSearch');
    const results = document.getElementById('categoryNameResults');
    const idInput = document.getElementById('categoryId');

    if (!input || !results || !idInput) return;

    const run = debounce(async () => {
      const q = (input.value || '').trim();
      if (q.length < 2) {
        results.style.display = 'none';
        results.innerHTML = '';
        return;
      }

      try {
        const rows = await searchCategoriesByName(q);
        renderTypeaheadResults(results, rows.slice(0, 25), (picked) => {
          idInput.value = picked.id;
          input.value = picked.name;
          results.style.display = 'none';
          results.innerHTML = '';
          // do NOT auto-load products; user clicks "Load Products from Category"
        });
      } catch (e) {
        results.style.display = 'grid';
        results.innerHTML = `<div style="color:#dc3545;font-weight:700;">${escapeHtml(e.message)}</div>`;
      }
    }, 250);

    input.addEventListener('input', run);

    document.addEventListener('click', (e) => {
      if (e.target === input || results.contains(e.target)) return;
      results.style.display = 'none';
    });
  }

  /* ===============================
     Modifiers
  ================================ */
  function addModifier() {
    modifierCount++;
    const container = document.getElementById('modifierList');

    const div = document.createElement('div');
    div.className = 'modifier-item';
    div.id = `modifier-${modifierCount}`;

    div.innerHTML = `
      <input type="text" placeholder="Display Name" id="name-${modifierCount}">
      ${getTypeSelectHtml(modifierCount, 'checkbox')}
      <input type="number" placeholder="Sort Order" id="sort-${modifierCount}" min="0">
      <input type="number" placeholder="Price (+$)" id="price-${modifierCount}" min="0">
      <button class="btn-secondary" onclick="removeModifier(${modifierCount})">Remove</button>
    `;

    container.appendChild(div);
    onTypeChange(modifierCount);
  }

  function addModifierConfig(displayName, type, sortOrder, price) {
    modifierCount++;
    const container = document.getElementById('modifierList');

    const div = document.createElement('div');
    div.className = 'modifier-item';
    div.id = `modifier-${modifierCount}`;

    div.innerHTML = `
      <input type="text" id="name-${modifierCount}" value="${escapeHtml(displayName || '')}">
      ${getTypeSelectHtml(modifierCount, type || 'checkbox')}
      <input type="number" id="sort-${modifierCount}" value="${Number.isFinite(sortOrder) ? sortOrder : 0}" min="0">
      <input type="number" id="price-${modifierCount}" value="${price ?? ''}" min="0">
      <button class="btn-secondary" onclick="removeModifier(${modifierCount})">Remove</button>
    `;

    container.appendChild(div);
    onTypeChange(modifierCount);
  }

  function removeModifier(id) {
    document.getElementById(`modifier-${id}`)?.remove();
  }

  function clearConfig() {
    document.getElementById('modifierList').innerHTML = '';
    modifierCount = 0;
  }

  function loadPreset(type) {
    clearConfig();
    if (type === 'standard') {
      addModifierConfig('Full Size Card', 'checkbox', 9, 5);
      addModifierConfig('Custom Ribbon', 'checkbox', 10, 5);
    } else {
      addModifier();
      addModifier();
    }
  }

  function getModifierConfig() {
    const config = [];

    for (let i = 1; i <= modifierCount; i++) {
      const name = document.getElementById(`name-${i}`)?.value;
      if (!name) continue;

      const type = document.getElementById(`type-${i}`)?.value || 'checkbox';

      const sort = parseInt(document.getElementById(`sort-${i}`)?.value, 10);
      const price = parseInt(document.getElementById(`price-${i}`)?.value, 10);

      let cfg = {};
      if (type === 'checkbox') cfg = { checked_by_default: false };
      if (type === 'text') cfg = { default_value: "" };
      if (type === 'multi_line_text') cfg = { default_value: "" };
      if (type === 'date') cfg = {};

      config.push({
        display_name: name,
        type,
        required: false,
        sort_order: Number.isFinite(sort) ? sort : 0,
        price_adjuster: (type === 'checkbox' && Number.isFinite(price) && price > 0) ? price : null,
        config: cfg
      });
    }

    return config;
  }

  /* ===============================
     Options
  ================================ */
  function getDeleteOptions() {
    const mode = document.querySelector('input[name="deleteMode"]:checked')?.value || 'match';

    if (mode === 'none') return { deleteBeforeApply: false };

    if (mode === 'all') return { deleteBeforeApply: true, deleteMode: 'all' };

    const raw = document.getElementById('deleteNameIncludes')?.value || '';
    const names = raw.split(',').map(x => x.trim()).filter(Boolean);

    return {
      deleteBeforeApply: true,
      deleteMode: 'match',
      deleteNameIncludes: names.length ? names : ['Custom Ribbon', 'Full Size Card'],
    };
  }

  function wireOptionToggles() {
    const modeInputs = document.querySelectorAll('input[name="deleteMode"]');
    const row = document.getElementById('matchNamesRow');

    function update() {
      const mode = document.querySelector('input[name="deleteMode"]:checked')?.value || 'match';
      row.style.display = (mode === 'match') ? 'flex' : 'none';
    }

    modeInputs.forEach(i => i.addEventListener('change', update));
    update();
  }

  /* ===============================
     Actions / Results
  ================================ */
  function setBusy(isBusy) {
    const applyBtn = document.getElementById('applyBtn');
    const removeBtn = document.getElementById('removeBtn');

    applyBtn.disabled = isBusy;
    removeBtn.disabled = isBusy;

    applyBtn.textContent = isBusy ? 'Working‚Ä¶' : 'Apply Modifier Set';
    removeBtn.textContent = isBusy ? 'Working‚Ä¶' : 'Remove ALL Modifiers';
  }

  function showResults(title, results) {
    const container = document.getElementById('results');
    container.innerHTML = `<h2 style="color:#667eea;margin-bottom:10px;">${escapeHtml(title)}</h2>`;

    (results || []).forEach(r => {
      const hasError = !!r.error || (r.errors && r.errors.length);
      const name = r.productName ? `${r.productName} ` : '';
      const header = `${name}(ID: ${r.productId})`;

      const div = document.createElement('div');
      div.className = `result-item ${hasError ? 'error' : ''}`;

      let html = `<div class="result-header">${escapeHtml(header)}</div>`;
      html += `<div class="result-details">`;

      if (r.error) {
        html += `<div style="color:#dc3545;">‚ùå ${escapeHtml(r.error)}</div>`;
      } else {
        if (r.deleted?.length) html += `<div>üóëÔ∏è Deleted: ${escapeHtml(r.deleted.join(', '))}</div>`;
        if (r.created?.length) html += `<div style="color:#28a745;">‚úì Created: ${escapeHtml(r.created.join(', '))}</div>`;
        if (r.errors?.length) html += `<div style="color:#dc3545;">‚ö†Ô∏è Errors: ${escapeHtml(r.errors.join(', '))}</div>`;
      }

      html += `</div>`;
      div.innerHTML = html;
      container.appendChild(div);
    });
  }

  async function applyModifiers() {
    const productIds = getCheckedIds();
    const modifierConfig = getModifierConfig();

    if (!productIds.length) return alert('Please select (check) at least one product.');
    if (!modifierConfig.length) return alert('Please configure at least one modifier.');

    setBusy(true);
    document.getElementById('results').innerHTML = `<div class="loading">Applying modifiers‚Ä¶</div>`;

    try {
      const res = await fetch('/api/bulk-apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productIds,
          modifierConfig,
          ...getDeleteOptions(),
        })
      });

      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.error || 'Bulk apply failed');

      showResults('Apply Results', data);
    } catch (e) {
      console.error(e);
      alert(e.message);
    } finally {
      setBusy(false);
    }
  }

  async function removeAllModifiers() {
    const productIds = getCheckedIds();
    if (!productIds.length) return alert('Please select (check) at least one product.');

    const ok = confirm(`Remove ALL modifiers from ${productIds.length} product(s)? This cannot be undone.`);
    if (!ok) return;

    setBusy(true);
    document.getElementById('results').innerHTML = `<div class="loading">Removing all modifiers‚Ä¶</div>`;

    try {
      const res = await fetch('/api/bulk-delete-modifiers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productIds,
          mode: 'all'
        })
      });

      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.error || 'Bulk delete failed');

      showResults('Delete Results', data);
    } catch (e) {
      console.error(e);
      alert(e.message);
    } finally {
      setBusy(false);
    }
  }

  /* ===============================
     Templates
  ================================ */
  let templatesCache = [];

  async function refreshTemplates() {
    const select = document.getElementById('templateSelect');
    select.innerHTML = `<option value="">Loading‚Ä¶</option>`;

    try {
      const res = await fetch('/api/templates');
      const data = await safeJson(res);
      templatesCache = data || [];

      if (!templatesCache.length) {
        select.innerHTML = `<option value="">No templates yet</option>`;
        return;
      }

      select.innerHTML =
        `<option value="">Select a template</option>` +
        templatesCache
          .map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`)
          .join('');
    } catch (e) {
      select.innerHTML = `<option value="">Failed to load</option>`;
    }
  }

  function quickSaveTemplateFromModifiers() {
    const cfg = getModifierConfig();
    if (!cfg.length) return alert('No modifiers to save.');

    const nameEl = document.getElementById('templateNameInput');
    let name = (nameEl?.value || '').trim();

    if (!name) {
      name = prompt('Template name?', 'New Modifier Template');
      if (!name) return;
      if (nameEl) nameEl.value = name;
    }

    // Uses your existing backend flow: POST /api/templates
    saveNewTemplate();
  }

  function loadSelectedTemplate() {
    const id = document.getElementById('templateSelect').value;
    if (!id) return alert('Select a template');

    const t = templatesCache.find(x => String(x.id) === String(id));
    if (!t) return alert('Template not found');

    clearConfig();

    (t.template_json || []).forEach(m => {
      addModifierConfig(
        m.display_name,
        m.type || 'checkbox',
        m.sort_order ?? 0,
        m.price_adjuster ?? ''
      );
    });

    document.getElementById('templateNameInput').value = t.name;
    setTemplateStatus(`Loaded template "${t.name}"`);
  }

  async function saveNewTemplate() {
    const name = document.getElementById('templateNameInput').value.trim();
    if (!name) return alert('Enter a template name');

    const template_json = getModifierConfig();
    if (!template_json.length) return alert('No modifiers to save');

    const res = await fetch('/api/templates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, template_json })
    });

    const data = await safeJson(res);
    if (!res.ok) return alert(data.error || 'Failed to save template');

    setTemplateStatus(`Saved new template "${data.name}"`);
    await refreshTemplates();
    document.getElementById('templateSelect').value = data.id;
    document.getElementById('templateNameInput').value = data.name;
  }

  async function updateTemplate() {
    const id = document.getElementById('templateSelect').value;
    if (!id) return alert('Select a template');

    const name = document.getElementById('templateNameInput').value.trim();
    if (!name) return alert('Enter a template name');

    const template_json = getModifierConfig();
    if (!template_json.length) return alert('No modifiers to save');

    const res = await fetch(`/api/templates/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, template_json })
    });

    const data = await safeJson(res);
    if (!res.ok) return alert(data.error || 'Failed to update template');

    setTemplateStatus(`Updated template "${data.name}"`);
    await refreshTemplates();
    document.getElementById('templateSelect').value = id;
    document.getElementById('templateNameInput').value = data.name;
  }

  async function deleteTemplate() {
    const id = document.getElementById('templateSelect').value;
    if (!id) return alert('Select a template');

    const t = templatesCache.find(x => String(x.id) === String(id));
    const ok = confirm(`Delete template "${t?.name}"?`);
    if (!ok) return;

    const res = await fetch(`/api/templates/${id}`, { method: 'DELETE' });
    if (!res.ok) return alert('Failed to delete template');

    clearConfig();
    document.getElementById('templateSelect').value = '';
    document.getElementById('templateNameInput').value = '';
    setTemplateStatus('Template deleted');

    await refreshTemplates();
    document.getElementById('templateSelect').value = '';
  }

  function setTemplateStatus(msg) {
    document.getElementById('templateStatus').textContent = msg || '';
  }
</script>

</body>
</html>